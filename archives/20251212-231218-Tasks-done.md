# テストプログラムのリファクタリング タスクリスト

`pi0servo` プロジェクトの `tests/` ディレクトリ配下にあるテストプログラム全体を対象に、テストの妥当性を検証し、不要なテストを削除し、必要なテストを追加することで、テストスイートの品質と効率を向上させるためのタスクリストです。

## A. CLIクライアントとAPIサーバーの統合テスト (最優先)

- [x] **A-1. モックAPIサーバーのフィクスチャ導入:**
    - `conftest.py` に、テスト中にバックグラウンドで起動するモックAPIサーバー（`uvicorn` と `FastAPI` を使ったシンプルなもの）を定義するフィクスチャを追加する。
    - このモックサーバーは `ThreadWorker` と `MultiServo` を内部でモックできるような仕組みを検討する。
- [x] **A-2. `test_15_cli_api_server.py` の拡充:**
    - モックAPIサーバーの起動後、HTTPクライアント (`requests` ライブラリ) を使って主要なAPIエンドポイントにリクエストを送信し、正しいレスポンスが返ってくることを検証するテストを追加する。
    - 有効なリクエストだけでなく、無効なリクエスト（必須パラメータ不足、不正な値）に対するエラーレスポンス（ステータスコード、エラーメッセージ）もテストする。
- [x] **A-3. `test_13_cli_api_client.py` の拡充:**
    - モックAPIサーバーを前提として、`api-client` から各種コマンドを送信し、APIサーバー経由でバックエンドが正しく呼び出され、レスポンスがクライアントに適切に返されることを検証する。
    - 履歴機能 (`--history_file`) のテストを追加する。
    - ネットワークエラー、サーバーからのエラーレスポンスなど、より多様なエラーシナリオのテストを追加する。
- [x] **A-4. `test_14_cli_str_client.py` の拡充:**
    - モックAPIサーバーを前提として、`str-client` から各種文字列コマンドを送信し、APIサーバー経由でバックエンドが正しく呼び出され、レスポンスがクライアントに適切に返されることを検証する。
    - 履歴機能 (`--history_file`) のテストを追加する。
    - `StrCmdToJson` との連携テストを強化し、様々な文字列コマンド形式が正しく処理されることを確認する。
- [x] **A-5. `test_16_cli_api_cli.py` の拡充:**
    - モックAPIサーバーを前提として、`api-cli` から各種コマンドを送信し、APIサーバー経由でバックエンドが正しく呼び出され、レスポンスがクライアントに適切に返されることを検証する。
    - 履歴機能 (`--history_file`) のテストを追加する。
    - `PINS` 引数が内部でどのように利用されるか検証するテストを追加する。
    - JSON-RPCエラーコードが正しく表示されることを確認する。
- [x] **A-6. `test_17_cli_str_cli.py` の拡充:**
    - モックAPIサーバーを前提として、`str-cli` から各種文字列コマンドを送信し、APIサーバー経由でバックエンドが正しく呼び出され、レスポンスがクライアントに適切に返されることを検証する。
    - 履歴機能 (`--history_file`) のテストを追加する。
    - `PINS` 引数が内部でどのように利用されるか検証するテストを追加する。
    - `StrCmdToJson` との連携テストを強化し、様々な文字列コマンド形式が正しく処理されることを確認する。
    - JSON-RPCエラーコードが正しく表示されることを確認する。

## B. コアロジックのエラーハンドリングと堅牢性の強化

- [x] **B-1. `test_01_piservo.py` の拡充:**
    - `pigpio` の操作でエラーが発生した場合の `PiServo` の振る舞い（例: 例外処理、フォールバック）を検証するテストを追加する。
- [x] **B-2. `test_02_servo_config_manager.py` の拡充:**
    - ファイルI/Oエラー（パーミッションエラー、ディスクフルなど）発生時の挙動を検証するテストを追加する。
    - 空のJSONファイルや、不正な構造のJSONファイルに対する `read_all_configs` の挙動を検証するテストを追加する。
    - `save_config` や `save_all_configs` に不正なデータ構造が渡された場合のバリデーションテストを追加する。
- [x] **B-3. `test_05_threadworker.py` の拡充:**
    - コマンドキューへの複数のコマンドの同時追加時に、正しい順序で処理されることを検証するテストを追加する。
    - スレッドの異常終了と再起動に関する堅牢性テストを追加する。
    - エラーハンドリング時のログ出力が期待通りに行われることを検証するテストを追加する。
    - `wait` コマンドのタイムアウトに関するテストを追加する。
    - `_cmdq` がいっぱいになった場合の `send()` の挙動（ブロック、例外発生、破棄など）を検証するテストを追加する。

## C. 文字列コマンドパーサーの網羅性強化

- [x] **C-1. `test_06_str_cmd_to_json.py` の拡充:**
    - 文字列解析の堅牢性を高めるテストを追加する。具体的には、大文字・小文字の区別、多様な空白文字の扱い、未知のショートカット文字列、浮動小数点数や特殊な数値フォーマットに関するテストケースを追加する。

## D. インタラクティブテストとユーティリティの拡充

- [x] **D-1. `test_07_threadworker_send_recv.py` の役割明確化と拡充:**
    - `ThreadWorker` の送受信メカニズムに特化させ、クエリコマンド（例: `get_all_angles`）の結果取得や非同期的な動作を検証するテストを追加する。
    - `test_05_threadworker.py` とのテスト重複を解消し、それぞれのテストファイルの役割を明確にする。
- [x] **D-2. `test_08_commonlib.py` の拡充:**
    - `pins_str2list` メソッドに対するテストケースをさらに多様化する（空文字列、スペースのみ、有効と無効な指定の混合など）。
    - `commonlib.py` 内に `pins_str2list` 以外のメソッドがあれば、それらのテストを追加する。
- [x] **D-3. `test_12_cli_calib.py` の拡充:**
    - キャリブレーションツールで設定した値がファイルに保存され、その後正しく読み込まれることのエンドツーエンドテストを追加する。
    - インタラクティブな移動/保存コマンド（`w`, `s`, `ENTER` など）の網羅的なテストを追加する。

## E. サンプルプログラムのテスト強化

- [x] **E-1. `test_51_samples.py`, `test_52_samples_interactive.py` の拡充:**
    - 各サンプルプログラムの標準出力/エラー出力が期待通りであることを検証するテストを追加する。
    - サンプルプログラムが生成するファイル（設定ファイルなど）の内容を検証するテストを追加する。
    - `samples/` ディレクトリ内の全てのサンプルプログラムをテスト対象に含める。
    - インタラクティブなサンプルプログラムに対して、`cli_runner.test_interactive` を使った入力と出力の検証を追加する。

---
**注意事項:**
*   リファクタリングは上記チェックリストの項目ごとに、段階的に行います。
*   各項目を完了したら、その都度 `uv run pytest` で全体のテストがパスすることを確認します。
*   不要なテストの特定と削除は、上記の追加・修正作業と並行して行い、テストカバレッジや品質に悪影響が出ないように注意します。
*   計画の進行中に新たな課題や改善点が見つかった場合は、このリストを更新します。