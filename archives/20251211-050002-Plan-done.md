# テストコードのリファクタリング計画

## 目的
`tests/` ディレクトリ内のテストコードの可読性、保守性、および一貫性を向上させる。特に、CLIテストフレームワークである `_testbase_cli.py` に焦点を当て、以下の改善を行う。

## 改善点

### 1. Docstring の追加と改善
- **対象ファイル**: `_testbase_cli.py`
- **詳細**:
    - `InteractiveSession` クラス内の `assert_in_out`, `assert_in_out_list` メソッドに詳細な docstring を追加する。
    - `CLITestBase` クラス内の主要なヘルパーメソッド（例: `_cmdline`, `run_command`, `assert_out_str`, `assert_result`, `test_command`, `run_interactive_command`, `test_interactive`, `assert_output_contains`, `assert_output_equals`, `assert_return_code`）の docstring を確認し、不足があれば追記・改善する。
    - Docstring はプロジェクトのコメント規約（日本語、78文字以内）に従う。

### 2. 型ヒント (Type Hinting) の追加と改善
- **対象ファイル**: `_testbase_cli.py`
- **詳細**:
    - `_testbase_cli.py` 内のすべての関数、メソッドの引数と戻り値に型ヒントを適切に追加する。
    - 既存の型ヒントについても、より具体的で正確な型情報に更新する。

### 3. デバッグ出力のロギングへの移行
- **対象ファイル**: `_testbase_cli.py`
- **詳細**:
    - 現在 `InteractiveSession` クラス内でデバッグ目的で使用されている `print` ステートメント（例: `print(f"## key-input: {key!r}")`, `print(f"### excpect: {pattern!r}")` など）を、`pi0servo.utils.mylogger` モジュールから提供されるロギング機能に置き換える。
    - ロギングレベルを設定できるようにし、通常テスト実行時にはデバッグ出力が抑制され、必要に応じて詳細なログが出力されるようにする。

### 4. `CLITestBase` クラスの`subprocess`関連の修正

- **対象ファイル**: `_testbase_cli.py`
- **詳細**:
    - `CLITestBase` クラスの`subprocess`関連の修正
    - CLIテストにおいて、`subprocess`の`run`メソッド実行時に`encoding`ではなく`text=True`を使用するように修正する。
    - `text=True`は`encoding`、`errors`、`newline`引数を扱い、`stdout`、`stderr`をテキストモードで開くため、`encoding`を別途指定する必要はなくなる。
    - また`input`引数も自動的にエンコードされるようになるため、引数から`encoding`を削除する。

## 作業手順 (Tasks.md に分割予定)
1. `_testbase_cli.py` の `InteractiveSession` クラスの `docstring` を追加・改善する。
2. `_testbase_cli.py` の `CLITestBase` クラスの `docstring` を追加・改善する。
3. `_testbase_cli.py` の `InteractiveSession` クラスの型ヒントを追加・改善する。
4. `_testbase_cli.py` の `CLITestBase` クラスの型ヒントを追加・改善する。
5. `_testbase_cli.py` のデバッグ `print` 出力をロギングに移行する。
6. `_testbase_cli.py` の `CLITestBase` クラスの `subprocess`関連の修正を行う。
