# Plan for Simplifying `tests/test_07_threadworker.py`

## 1. 現状分析と問題点

`tests/test_07_threadworker.py` は `ThreadWorker` クラスの機能を検証するためのテストスイートである。`MultiServo` クラスは `mocker_multiservo` フィクスチャによってモックされている。

### 1.1. 構造と機能

*   **`mocker_multiservo` フィクスチャ**: `MultiServo` クラスのコンストラクタをモックし、`MultiServo` インスタンスのモックを返す。
*   **`thread_worker` フィクスチャ**: モックされた `MultiServo` を使用して `ThreadWorker` インスタンスを生成し、スレッドを開始・終了する。
*   **`TestThreadWorker` クラス**: `ThreadWorker` が処理する各種コマンド（角度移動、パルス移動、設定など）と無効なコマンドのハンドリングをテストする。

### 1.2. 問題点

1.  **`MultiServo` モックの誤った使用**: 多くのテストメソッド内で `mservo = mocker_multiservo()` が呼び出されているが、これは `MultiServo` のコンストラクタのモックであり、`ThreadWorker` が実際に使用している `MultiServo` インスタンスのモックではない。`ThreadWorker` が使用しているインスタンスは `thread_worker.mservo` でアクセス可能である。この誤ったモックの使用により、テストが意図しない対象を検証している可能性がある。
2.  **`time.sleep(0.5)` の多用**: スレッド間の同期に `time.sleep(0.5)` が使われている。これはテストを遅く、不安定にする原因となる。

## 2. 改善案

上記の問題点を解決し、テストコードをよりシンプルで分かりやすく、信頼性の高いものにするための改善案を以下に示す。

### 2.1. `MultiServo` モックの正しい使用

*   **変更内容**: 各テストメソッド内で `mservo = mocker_multiservo()` の呼び出しを削除し、代わりに `thread_worker.mservo` を使用して `MultiServo` インスタンスのモックにアクセスするように修正する。
*   **目的**: `ThreadWorker` が実際に操作している `MultiServo` インスタンスのモックに対してアサーションを行うことで、テストの正確性を保証する。

### 2.2. `time.sleep` の排除と同期メカニズムの導入

*   **変更内容**: `time.sleep(0.5)` を、モックの呼び出しを待機するヘルパー関数に置き換える。
    *   `TestThreadWorker` クラス内に `_wait_for_mock_call(mock_obj, timeout=1.0)` のようなヘルパーメソッドを導入する。
    *   このヘルパーメソッドは、指定されたモックオブジェクトの `call_count` が `0` より大きくなるまで短い間隔でポーリングし、タイムアウトを設定する。
*   **目的**: テストの実行速度と信頼性を向上させる。固定の `sleep` 時間に依存しない、より堅牢な同期を実現する。

### 2.3. コマンド送信とアサーションのヘルパー化 (オプション)

*   **変更内容**: コマンドの送信、待機、および一般的なアサーション（`assert_called_once_with` や `qsize` の確認）をカプセル化するヘルパーメソッド `_send_and_assert_command(self, cmd, expected_method_call, expected_qsize=0)` を導入する。
*   **目的**: テストコードの重複を減らし、可読性を向上させる。各テストメソッドの主要なロジックに集中できるようにする。

## 3. 実施計画

1.  **`MultiServo` モックの修正**: 全てのテストメソッドで `thread_worker.mservo` を使用するように修正する。
2.  **同期ヘルパーの導入**: `_wait_for_mock_call` ヘルパーメソッドを `TestThreadWorker` クラスに追加し、既存の `time.sleep` を置き換える。
3.  **テストの実行と検証**: 上記の変更後、全てのテストがパスすることを確認する。
4.  **`_send_and_assert_command` ヘルパーの導入 (オプション)**: 必要に応じて、コマンド送信とアサーションをカプセル化するヘルパーメソッドを導入する。

## 4. ソースコードの修正はまだ行わない

この計画は、`tests/test_07_threadworker.py` の修正方針をまとめたものであり、まだ実際のコード修正は行わない。