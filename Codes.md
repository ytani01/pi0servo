# src/ ディレクトリの概要

`src/pi0servo/` ディレクトリには、`pigpio` ライブラリを利用して Raspberry Pi Zero 2W 上でサーボを制御するためのコアロジックとインターフェースが含まれています。アーキテクチャはモジュール化されており、`core`、`command`、`helper`、`utils`、`web` の各サブディレクトリに機能が分離されています。

## 1. `core/` (コアサーボ制御ロジック):
    *   **`piservo.py`**: `pigpio` を使用して単一のサーボを制御するための基本的なインターフェースを提供します。パルス幅の設定とサーボのアクティブ状態の管理を行います。
    *   **`calibrable_servo.py`**: `PiServo` を拡張し、キャリブレーション機能を追加します。最小、最大、中央のパルス幅を定義し、角度をパルス幅に変換します。キャリブレーションデータの永続的な保存には `ServoConfigManager` を使用します。
    *   **`multi_servo.py`**: `CalibrableServo` インスタンスのコレクションを管理します。複数のサーボを同時に制御するためのメソッドを提供し、同期移動や管理下のすべてのサーボへのコマンドブロードキャストを可能にします。

## 2. `command/` (コマンドラインインターフェース):
    *   **`cmd_servo.py`**: 主に `PiServo` を使用したパルス幅操作による直接的なサーボ制御のための基本的な CLI を実装します。
    *   **`cmd_calib.py`**: サーボをキャリブレーションするための対話型 CUI を提供します。`CalibrableServo` と `blessed` ライブラリを使用して、ターミナルベースのユーザーインターフェースを実現します。
    *   **`cmd_apicli.py`**: JSON 形式のコマンドをローカルの `ThreadWorker` に送信し、`MultiServo` を制御するための CLI を実装します。共通の CLI 機能には `CmdAppCliBase` を使用します。
    *   **`cmd_apiclient.py`**: リモート API サーバーと対話するための CLI クライアントを実装します。`ApiClient` を使用して HTTP 経由で JSON コマンドを送信します。
    *   **`cmd_strcli.py`**: `cmd_apicli.py` を拡張し、文字列ベースのコマンドを受け入れます。これらのコマンドは `StrCmdToJson` を使用して JSON にパースされた後、ローカルの `ThreadWorker` に送信されます。
    *   **`cmd_strclient.py`**: `cmd_apiclient.py` を拡張し、文字列ベースのコマンドを受け入れます。`StrCmdToJson` を使用してパースされた後、リモート API サーバーに送信されます。

## 3. `helper/` (ヘルパーユーティリティ):
    *   **`str_cmd_to_json.py`**: 人間が読める文字列コマンド（例: "mv:40,30", "sl:0.5"）を、構造化された JSON コマンド辞書にパースするための重要なモジュールです。角度のエイリアス、パラメータのパースを処理し、サーボの方向反転のために `angle_factor` を適用します。
    *   **`thread_multi_servo.py`**: 複数のサーボを非同期で制御するためのインターフェースを提供します。`MultiServo` と `ThreadWorker` をラップし、コマンドをキューに入れて別のスレッドで実行することで、メインアプリケーションのブロックを防ぎます。
    *   **`thread_worker.py`**: キューからのコマンドを処理する汎用ワーカー スレッドの実装です。適切なハンドラにコマンドをディスパッチし、コマンドの実行を管理し、コマンドのキャンセルやキューの状態確認のメカニズムを提供します。また、標準化された JSON 応答形式を定義します。

## 4. `utils/` (汎用ユーティリティ):
    *   **`clibase.py`**: CLI アプリケーションの基底クラスで、入力プロンプト、`readline` を使用したコマンド履歴管理、基本的なコマンドディスパッチなどの共通機能を提供します。

    *   **`my_logger.py`**: ロガーインスタンスを取得および設定するための標準化された方法を提供するカスタムロギングユーティリティで、動的な命名とデバッグレベル制御が含まれます。
    *   **`servo_config_manager.py`**: JSON ファイル内のサーボキャリブレーションデータの読み書きと検索を管理します。現在のディレクトリ、ホームディレクトリ、`/etc/` で設定ファイルを検索する機能をサポートしています。

## 5. `web/` (Web API コンポーネント):
    *   **`api_client.py`**: Web API に JSON データを含む HTTP POST リクエストを行うためのクライアントです。`requests` ライブラリを使用し、ネットワークの問題に対するエラー処理を提供します。
    *   **`json_api.py`**: HTTP 経由でサーボ制御機能を提供する FastAPI アプリケーションを実装します。`uvicorn` を使用して API を提供し、`JsonApi` クラスを利用して `MultiServo` と `ThreadWorker` を管理し、環境変数を使用して設定を行います。

## 全体的なアーキテクチャ:

このプロジェクトは、サーボを制御するための適切に構造化されたアプローチを示しています。低レベルのハードウェアインタラクション（`piservo`）と、キャリブレーション（`calibrable_servo`）やマルチサーボ制御（`multi_servo`）などの高レベルの概念を分離しています。`ThreadWorker` と `ThreadMultiServo` の使用により、サーボコマンドを非同期で処理できるため、応答性の高いアプリケーションにとって非常に重要です。

プロジェクトは、制御のために複数のインターフェースを提供します。
*   **直接 CLI**: `cmd_servo` は基本的な制御用、`cmd_calib` は対話型キャリブレーション用。
*   **JSON ベース CLI**: `cmd_apicli` はローカル制御用、`cmd_apiclient` はリモート制御用。
*   **文字列ベース CLI**: `cmd_strcli` はローカル制御用、`cmd_strclient` はリモート制御用。
*   **Web API**: `json_api` はリモート制御用の HTTP インターフェースを提供します。

`StrCmdToJson` モジュールは、人間が読める文字列コマンドと内部の JSON コマンド形式との間の橋渡し役となり、使いやすさを向上させています。`ServoConfigManager` はキャリブレーションデータの永続性を提供し、`my_logger` と `clibase` は不可欠なユーティリティ機能を提供します。

Web API（`json_api`）での環境変数の使用は、デプロイの柔軟性のための良いプラクティスです。
