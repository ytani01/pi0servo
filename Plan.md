# テストプログラムのリファクタリング計画

**目的:** `pi0servo` プロジェクトの `tests/` ディレクトリ配下にあるテストプログラム全体を対象に、テストの妥当性を検証し、不要なテストを削除し、必要なテストを追加することで、テストスイートの品質と効率を向上させる。

**計画ステップ:**

1.  **テストプログラムの全体把握とカテゴリ分類:**
    *   `tests/` ディレクトリ内の全テストファイル（`test_*.py`）をリストアップする。
    *   各テストファイルがカバーしている機能領域（例: `piservo`、`calibrable_servo`、`multi_servo`、CLIコマンド、APIなど）を特定し、カテゴリに分類する。

2.  **各テストファイルの機能と目的の分析:**
    *   各テストファイルの内容を読み込み、テスト対象の機能（SUT: System Under Test）と、そのテストが検証しようとしている具体的な項目（テストケース）を理解する。
    *   特に、モックの使用状況（`_pigpio_mock.py`や`conftest.py`など）を確認し、依存関係を把握する。
    *   `_testbase_cli.py`のような共通ユーティリティや基底クラスの使われ方を分析し、重複や改善点がないか検討する。

3.  **テスト項目の妥当性検証:**
    *   **既存テストのレビュー:**
        *   各テストケースが、意図した機能を正しく検証しているか？
        *   テストの粒度は適切か？（小さすぎず、大きすぎないか）
        *   アサーションは明確で、具体的な期待値を検証しているか？
        *   テスト名はその目的を明確に表しているか？
        *   テストが独立しており、他のテストに影響を与えないか？
        *   テストデータは適切か？（エッジケース、無効な入力なども考慮されているか）
    *   **コードカバレッジの考慮:**
        *   現在のテストスイートがどの程度のコードカバレッジを達成しているかを評価する（直接カバレッジツールを実行するのではなく、コードを読んで判断する）。
        *   カバレッジが低い部分や、重要なロジックがテストされていない部分を特定する。

4.  **不要なテストの特定と削除:**
    *   **重複テストの特定:** 同じ機能を重複して検証しているテストがないか確認する。
    *   **陳腐化したテストの特定:** 過去の機能変更により、もはや関連性のない、あるいは誤った期待値を検証しているテストがないか確認する。
    *   **低品質なテストの特定:** 壊れやすい、メンテナンスが困難、読みにくいなどの問題があるテストを特定し、改善または削除を検討する。

5.  **必要なテストの特定と追加:**
    *   **未テスト機能の特定:** 新規機能や既存機能の重要なロジックで、まだテストされていない部分を特定する。
    *   **エッジケース/境界値テストの追加:** 既存機能のテストで、エッジケースや境界値の検証が不足している部分にテストを追加する。
    *   **バグレポートに基づくテストの追加:** 過去に報告されたバグを再現するテストケースを追加し、将来的な回帰を防ぐ。
    *   **ドキュメントや仕様に基づくテストの追加:** `README.md`や`docs/`にある仕様（例: `STR_CMD.md`、`JSONCMD_SAMPLES.md`）と実際のテストを比較し、仕様が完全にカバーされているか確認する。

6.  **テストコードの標準化と整理:**
    *   命名規則、ディレクトリ構造、モックの利用方法など、一貫性のあるテストコードのスタイルを適用する。
    *   共通のセットアップ/ティアダウン処理は`conftest.py`に集約するなど、ベストプラクティスを適用する。
    *   可読性向上のために、テストコードのコメントやドキュメントを更新する。

**注意事項:**

*   リファクタリングは段階的に行い、各ステップでテストがパスすることを確認する。
*   変更を行う前に、`uv run pytest`で現在の全てのテストがパスすることを確認する。

---

## 各テストファイル分析に基づくリファクタリング案と優先順位

**全体のリファクタリング目標:**
*   テストスイートの網羅性と堅牢性の向上
*   不要なテストの排除（現時点ではあまり見つからず）
*   テストコードの明確化と保守性の向上

**カテゴリ別リファクタリング案と優先順位 (高 → 低):**

**A. CLIクライアントとAPIサーバーの統合テスト (最優先)**
*   **課題:** 現在のCLIクライアント (`api-client`, `str-client`, `api-cli`, `str-cli`) のテストは、主にクライアント側のロジックや入力/出力形式を検証しており、実際にAPIサーバーと連携して期待通りの動作をするかの検証が不足している。`api-server` のテストも起動確認にとどまっている。
*   **影響:** この部分のテストが不足していると、クライアントとサーバー間のプロトコル変更や、`ThreadWorker` などのバックエンドロジックの変更が、システム全体に予期せぬ影響を与えるリスクが高い。
*   **提案:**
    1.  **モックAPIサーバーのフィクスチャ導入:** `conftest.py` に、テスト中にバックグラウンドで起動するモックAPIサーバー（例えば `uvicorn` と `FastAPI` を使ったシンプルなもの）を定義するフィクスチャを追加する。このモックサーバーは `ThreadWorker` と `MultiServo` を内部でモックできると理想的。
    2.  **`test_15_cli_api_server.py` の拡充:** サーバーの起動後、HTTPクライアント (`requests`) を使って主要なAPIエンドポイントにリクエストを送信し、正しいレスポンスが返ってくることを検証するテストを追加する。
    3.  **`test_13_cli_api_client.py`, `test_14_cli_str_client.py`, `test_16_cli_api_cli.py`, `test_17_cli_str_cli.py` の拡充:** 上記モックAPIサーバーを前提として、各クライアントから各種コマンドを送信し、APIサーバー経由でバックエンドが正しく呼び出され、レスポンスがクライアントに適切に返されることを検証する。

**B. コアロジックのエラーハンドリングと堅牢性の強化**
*   **課題:** `PiServo` (`test_01_piservo.py`) や `ServoConfigManager` (`test_02_servo_config_manager.py`)、`ThreadWorker` (`test_05_threadworker.py`) など、主要なコンポーネントでファイルI/Oエラー、不正な入力、スレッド内の例外などのエラーハンドリングに関するテストが不足している。
*   **影響:** これらのテストが不足していると、予期せぬ状況でアプリケーションがクラッシュしたり、不正な状態になったりする可能性がある。
*   **提案:**
    1.  **`test_01_piservo.py` の拡充:** `pigpio` の操作でエラーが発生した場合の `PiServo` の振る舞いを検証するテストを追加。
    2.  **`test_02_servo_config_manager.py` の拡充:** ファイルI/Oエラー（パーミッション、ディスクフルなど）、空または不正な構造のJSONファイル、不正なデータ構造に対するバリデーションテストを追加。
    3.  **`test_05_threadworker.py` の拡充:** コマンドキューへの複数のコマンドの同時追加、スレッドの異常終了と再起動、ログ出力の検証、`wait` コマンドのタイムアウト、`_cmdq` がいっぱいになった場合の挙動に関するテストを追加。

**C. 文字列コマンドパーサーの網羅性強化**
*   **課題:** `StrCmdToJson` (`test_06_str_cmd_to_json.py`) の文字列解析に関して、大文字・小文字の区別、多様な空白文字、未知のショートカット文字列、数値フォーマットのバリエーションなど、より詳細なテストケースが不足している。
*   **影響:** ユーザーからの入力が多様な形式であった場合に、期待通りにコマンドが変換されない可能性がある。
*   **提案:**
    1.  **`test_06_str_cmd_to_json.py` の拡充:** 上記の課題に対応するテストケースを追加。

**D. インタラクティブテストとユーティリティの拡充**
*   **課題:** `test_07_threadworker_send_recv.py` は内容が簡素すぎ、`test_08_commonlib.py` も `pins_str2list` 以外のテストが不足している。`test_12_cli_calib.py` のキャリブレーション値の保存検証も必要。
*   **影響:** これらのユーティリティや特定のインタラクティブCLIの機能が完全にテストされていない。
*   **提案:**
    1.  **`test_07_threadworker_send_recv.py` の役割明確化と拡充:** `ThreadWorker` の送受信メカニズムに特化させ、クエリコマンドの結果取得や非同期的な動作を検証するテストを追加する。`test_05_threadworker.py` との重複を解消。
    2.  **`test_08_commonlib.py` の拡充:** `pins_str2list` のテストケースをさらに多様化し、`commonlib.py` 内に他のメソッドがあればそれらもテストする。
    3.  **`test_12_cli_calib.py` の拡充:** キャリブレーションツールで設定した値がファイルに保存され、その後正しく読み込まれることのエンドツーエンドテストを追加する。

**E. サンプルプログラムのテスト強化**
*   **課題:** `test_51_samples.py` と `test_52_samples_interactive.py` はサンプルが「実行できる」ことしか確認しておらず、その「出力」や「動作結果」まで検証できていない。
*   **影響:** サンプルプログラムが意図しない動作をしてもテストで検出できない。
*   **提案:**
    1.  **`test_51_samples.py`, `test_52_samples_interactive.py` の拡充:** 各サンプルプログラムの標準出力/エラー出力、生成されるファイル内容、インタラクティブな動作の検証を追加する。全てのサンプルをテスト対象に含める。